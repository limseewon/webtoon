<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>에피소드 — 작가명</title>
  <meta name="description" content="작가명 웹툰 뷰어" />

  <style>
    /* ===== Theme (index.html 톤 앤 매너) ===== */
    :root {
      --bg: #050507;
      --card: rgba(17, 18, 25, .8);
      --card-strong: rgba(25, 27, 35, .95);
      --text: #fff;
      --muted: #8b92a8;
      --brand: #00ff88;
      --brand-dark: #00cc6a;
      --accent: #ff0080;
      --border: rgba(255, 255, 255, .08);
      --space: clamp(16px, 2.5vw, 24px);
      --radius-lg: 24px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    html {
      scroll-behavior: smooth;
      -webkit-tap-highlight-color: transparent
    }

    body {
      background: var(--bg);
      background-image:
        radial-gradient(circle at 20% 50%, rgba(0, 255, 136, .05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 0, 128, .05) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(120, 119, 198, .05) 0%, transparent 50%);
      color: var(--text);
      font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.6;
      min-height: 100dvh;
      position: relative;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 var(--space)
    }

    .container-narrow {
      max-width: 820px;
      margin: 0 auto;
      padding: 24px var(--space) 80px
    }

    /* Header */
    .site-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(5, 5, 7, .7);
      backdrop-filter: blur(18px) saturate(180%);
      border-bottom: 1px solid var(--border)
    }

    .site-header .container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      gap: 12px
    }

    .logo {
      font-size: clamp(20px, 2.4vw, 24px);
      font-weight: 900;
      background: linear-gradient(135deg, var(--brand), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    nav {
      display: flex;
      gap: 20px
    }

    nav a {
      color: var(--muted);
      text-decoration: none;
      font-weight: 800;
      font-size: 14px;
      position: relative;
      padding: 8px 2px
    }

    nav a::after {
      content: "";
      position: absolute;
      bottom: -6px;
      left: 0;
      width: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--brand), var(--accent));
      transition: width .2s ease
    }

    @media(hover:hover) {
      nav a:hover {
        color: #fff
      }

      nav a:hover::after {
        width: 100%
      }
    }

    /* Title/meta */
    #episode {
      margin-top: 18px
    }

    #ep-title {
      font-size: clamp(22px, 4.5vw, 36px);
      font-weight: 900;
      line-height: 1.2;
      margin-bottom: 6px;
      background: linear-gradient(180deg, #fff 0%, #8b92a8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .meta {
      color: var(--muted);
      margin-bottom: 16px
    }

    /* Top actions + prev/next */
    .top-actions {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 10px;
      align-items: center;
      margin: 16px 0 6px
    }

    .nav-episodes {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 10px 0 20px
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-decoration: none;
      border-radius: 999px;
      padding: 12px 16px;
      font-weight: 900;
      min-height: 44px
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--brand), var(--brand-dark));
      color: #001b11;
      border: 0
    }

    .btn-outline {
      background: var(--card);
      border: 1px solid var(--border);
      color: #fff
    }

    .btn.disabled,
    .btn[aria-disabled="true"] {
      opacity: .5;
      pointer-events: none
    }

    /* Like */
    .like-wrap {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--card)
    }

    .like-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: transparent;
      border: none;
      color: #fff;
      font-weight: 900;
      cursor: pointer
    }

    .like-btn svg {
      width: 20px;
      height: 20px
    }

    .like-btn.active {
      color: #ff4d88;
      filter: drop-shadow(0 0 8px rgba(255, 0, 128, .35))
    }

    /* Rating */
    .rating {
      display: inline-flex;
      align-items: center;
      gap: 8px
    }

    .stars {
      display: inline-flex;
      gap: 6px
    }

    .star {
      cursor: pointer;
      width: 24px;
      height: 24px;
      background: transparent;
      border: none;
      padding: 0
    }

    .star svg {
      width: 100%;
      height: 100%;
      fill: #1b1d28;
      stroke: #ffd166
    }

    .star.filled svg {
      fill: #ffd166
    }

    .my-rating {
      color: var(--muted);
      font-size: 14px
    }

    /* Viewer */
    .viewer {
      display: grid;
      gap: 12px
    }

    .viewer img {
      width: 100%;
      display: block;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .35);
      background: #0b0c10
    }

    .skeleton {
      height: 600px;
      background: linear-gradient(90deg, #0f1118 25%, #131522 37%, #0f1118 63%);
      background-size: 400% 100%;
      animation: shimmer 1.2s infinite;
      border: 1px solid #1b1d28;
      border-radius: 12px
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0
      }

      100% {
        background-position: -200% 0
      }
    }

    /* Paywall */
    .paywall {
      background: var(--card);
      border: 1px dashed var(--border);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      margin-top: 16px;
      box-shadow: 0 14px 40px rgba(0, 0, 0, .35)
    }

    .paywall h3 {
      font-size: 20px;
      margin-bottom: 8px;
      font-weight: 900
    }

    .paywall p {
      color: var(--muted);
      margin-bottom: 14px
    }

    .hidden {
      display: none !important
    }

    /* Comments */
    .comments {
      margin-top: 28px
    }

    .comments h3 {
      font-size: 20px;
      font-weight: 900;
      margin-bottom: 10px
    }

    .comment-form {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px
    }

    .comment-form input,
    .comment-form textarea {
      background: rgba(255, 255, 255, .04);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      outline: none
    }

    .comment-form textarea {
      min-height: 88px;
      resize: vertical
    }

    .comment-form .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px
    }

    .comment-list {
      display: grid;
      gap: 12px;
      margin-top: 12px
    }

    .comment {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px
    }

    .comment .meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 6px
    }

    .comment .body {
      white-space: pre-wrap;
      word-break: break-word
    }

    .comment .del {
      background: transparent;
      border: none;
      color: #ff6b6b;
      cursor: pointer;
      font-weight: 800
    }

    /* Footer */
    .site-footer {
      border-top: 1px solid var(--border);
      margin-top: 40px;
      padding: 18px 0 calc(18px + var(--safe-bottom));
      color: var(--muted);
      text-align: center
    }

    /* ===== Responsive (390 기준) ===== */
    @media (max-width:768px) {
      .container-narrow {
        padding: 16px var(--space) 64px
      }

      .top-actions {
        grid-template-columns: 1fr;
        gap: 8px
      }

      .nav-episodes {
        gap: 8px
      }

      .comment-form .row {
        grid-template-columns: 1fr
      }
    }

    @media (max-width:390px) {
      #ep-title {
        font-size: 22px
      }

      .nav-episodes {
        grid-template-columns: 1fr
      }

      .btn {
        width: 100%
      }

      .site-header .container {
        padding: 10px 0
      }
    }

    @media (prefers-reduced-motion:reduce) {
      * {
        animation: none !important;
        transition: none !important;
        scroll-behavior: auto !important
      }
    }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="container">
      <a class="logo" href="/">WEBTOON</a>
      <nav>
        <a href="/archive.html">아카이브</a>
        <a href="/support.html">후원</a>
      </nav>
    </div>
  </header>

  <main class="container-narrow">
    <article id="episode">
      <h1 id="ep-title">로딩 중…</h1>
      <p class="meta"><span id="ep-date">—</span> · <span id="ep-status">—</span></p>

      <div class="top-actions">
        <!-- 좋아요 -->
        <div class="like-wrap">
          <button id="likeBtn" class="like-btn" aria-pressed="false">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path
                d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 6 4 4 6.5 4c1.74 0 3.41.81 4.5 2.09C12.09 4.81 13.76 4 15.5 4 18 4 20 6 20 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
            </svg>
            <span id="likeCount">0</span>
          </button>
        </div>

        <!-- 별점 -->
        <div class="rating" aria-label="별점 주기">
          <div class="stars" id="stars" role="radiogroup" aria-label="별 1~5개">
            <button class="star" data-v="1" aria-label="1점" role="radio" aria-checked="false"><svg viewBox="0 0 24 24">
                <path
                  d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.786 1.401 8.168L12 18.896 4.665 23.164l1.401-8.168L.132 9.21l8.2-1.192z" />
              </svg></button>
            <button class="star" data-v="2" aria-label="2점" role="radio" aria-checked="false"><svg viewBox="0 0 24 24">
                <path
                  d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.786 1.401 8.168L12 18.896 4.665 23.164l1.401-8.168L.132 9.21l8.2-1.192z" />
              </svg></button>
            <button class="star" data-v="3" aria-label="3점" role="radio" aria-checked="false"><svg viewBox="0 0 24 24">
                <path
                  d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.786 1.401 8.168L12 18.896 4.665 23.164l1.401-8.168L.132 9.21l8.2-1.192z" />
              </svg></button>
            <button class="star" data-v="4" aria-label="4점" role="radio" aria-checked="false"><svg viewBox="0 0 24 24">
                <path
                  d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.786 1.401 8.168L12 18.896 4.665 23.164l1.401-8.168L.132 9.21l8.2-1.192z" />
              </svg></button>
            <button class="star" data-v="5" aria-label="5점" role="radio" aria-checked="false"><svg viewBox="0 0 24 24">
                <path
                  d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.786 1.401 8.168L12 18.896 4.665 23.164l1.401-8.168L.132 9.21l8.2-1.192z" />
              </svg></button>
          </div>
          <span class="my-rating" id="myRating">내 별점: -/5</span>
        </div>

        <!-- 공유 -->
        <div style="text-align:right">
          <a id="shareBtn" class="btn btn-outline" href="#">공유</a>
        </div>
      </div>

      <div class="nav-episodes">
        <a id="prev-link" class="btn btn-outline" href="#" aria-disabled="true">← 이전 화</a>
        <a id="next-link" class="btn btn-primary" href="#" aria-disabled="true">다음 화 →</a>
      </div>

      <div id="images" class="viewer" aria-live="polite">
        <div class="skeleton"></div>
        <div class="skeleton" style="height:520px"></div>
        <div class="skeleton" style="height:640px"></div>
      </div>

      <div id="paywall" class="paywall hidden">
        <h3>후원자 전용 에피소드</h3>
        <p>후원해 주시면 바로 열람할 수 있어요.</p>
        <a class="btn btn-primary" href="/support.html">✨ 후원하러 가기</a>
      </div>

      <!-- 댓글 -->
      <section class="comments" id="comments">
        <h3>댓글</h3>
        <form id="commentForm" class="comment-form" novalidate>
          <div class="row">
            <input id="cName" name="name" placeholder="닉네임 (2~20자)" minlength="2" maxlength="20" required />
            <button class="btn btn-primary" type="submit">등록</button>
          </div>
          <textarea id="cBody" name="body" placeholder="응원의 한마디를 남겨주세요 (최대 500자)" maxlength="500" required></textarea>
        </form>
        <div id="commentList" class="comment-list"></div>
      </section>

      <p style="color:var(--muted); margin-top:24px">끝까지 읽어주셔서 감사합니다 🙌</p>
    </article>
  </main>

  <footer class="site-footer">
    <div class="container"><small>© <span id="year"></span> 작가명</small></div>
  </footer>

  <script>
    // ---------- 유틸 ----------
    const qs = (s, el = document) => el.querySelector(s);
    const getParam = n => new URL(location.href).searchParams.get(n);
    const json = async url => { const r = await fetch(url, { cache: 'no-store' }); if (!r.ok) throw new Error('Fetch failed: ' + url); return r.json(); };
    const escapeHTML = (str = '') => str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));

    // 데모 저장소 키(localStorage)
    const LS = { like: 'webtoon_likes', rating: 'webtoon_ratings', comments: 'webtoon_comments' };
    const loadMap = key => { try { return JSON.parse(localStorage.getItem(key) || '{}'); } catch { return {}; } };
    const saveMap = (key, obj) => localStorage.setItem(key, JSON.stringify(obj));

    (async function init() {
      try {
        qs('#year').textContent = new Date().getFullYear();

        // manifest 로드
        const manifest = await json('/episodes/manifest.json'); // [{id,date,...}]
        const ids = manifest.episodes.map(e => e.id).sort();

        // id 없으면 최신화로 이동
        let id = getParam('id');
        if (!id) {
          const latest = [...manifest.episodes].sort((a, b) => new Date(b.date) - new Date(a.date))[0];
          location.replace(`/episode.html?id=${latest.id}`);
          return;
        }
        if (!ids.includes(id)) { location.replace('/archive.html'); return; }

        // 에피소드 데이터
        const data = await json(`/episodes/${id}/data.json`);

        // 메타
        qs('#ep-title').textContent = data.title;
        qs('#ep-date').textContent = new Date(data.date).toLocaleDateString('ko-KR');
        qs('#ep-status').textContent = data.locked ? '후원자 전용' : '무료';

        // 앞/뒤 회차 링크
        const index = ids.indexOf(id);
        const prevId = ids[index - 1] || null;
        const nextId = ids[index + 1] || null;
        const prev = qs('#prev-link');
        const next = qs('#next-link');
        if (prevId) { prev.href = `/episode.html?id=${prevId}`; prev.removeAttribute('aria-disabled'); } else { prev.classList.add('disabled'); }
        if (nextId) { next.href = `/episode.html?id=${nextId}`; next.removeAttribute('aria-disabled'); } else { next.classList.add('disabled'); }

        // 페이월
        if (data.locked) {
          qs('#images').innerHTML = '';
          qs('#paywall').classList.remove('hidden');
          return;
        }

        // 이미지 렌더
        const wrap = qs('#images');
        wrap.innerHTML = '';
        const frag = document.createDocumentFragment();
        data.images.forEach(src => {
          const img = new Image();
          img.src = src; img.alt = data.title; img.loading = 'lazy'; img.decoding = 'async';
          frag.appendChild(img);
        });
        wrap.appendChild(frag);

        // ===== 좋아요 =====
        const likeBtn = qs('#likeBtn');
        const likeCountEl = qs('#likeCount');
        const likes = loadMap(LS.like);
        const entry = likes[id] || { count: 0, me: false };
        likeBtn.classList.toggle('active', entry.me);
        likeBtn.setAttribute('aria-pressed', entry.me);
        likeCountEl.textContent = entry.count;
        likeBtn.addEventListener('click', () => {
          const state = likeBtn.classList.toggle('active');
          likeBtn.setAttribute('aria-pressed', state);
          const map = loadMap(LS.like);
          const e = map[id] || { count: 0, me: false };
          if (state && !e.me) { e.count++; e.me = true; }
          else if (!state && e.me && e.count > 0) { e.count--; e.me = false; }
          map[id] = e; saveMap(LS.like, map);
          likeCountEl.textContent = e.count;
        });

        // ===== 별점 (1~5) =====
        const starsEl = qs('#stars');
        const myEl = qs('#myRating');
        const ratings = loadMap(LS.rating);
        const my = ratings[id]?.score || 0;
        const setStars = (n) => {
          starsEl.querySelectorAll('.star').forEach((s, i) => {
            const filled = i < n; s.classList.toggle('filled', filled); s.setAttribute('aria-checked', filled && i === n - 1);
          });
          myEl.textContent = `내 별점: ${n || '-'}/5`;
        };
        setStars(my);
        starsEl.addEventListener('click', (e) => {
          const btn = e.target.closest('.star'); if (!btn) return;
          const v = Number(btn.dataset.v);
          setStars(v);
          const map = loadMap(LS.rating); map[id] = { score: v, at: Date.now() }; saveMap(LS.rating, map);
        });

        // ===== 댓글 =====
        const listEl = qs('#commentList');
        const form = qs('#commentForm');
        const nameInput = qs('#cName');
        const bodyInput = qs('#cBody');

        const readComments = () => (loadMap(LS.comments)[id] || []);
        const writeComments = (arr) => { const map = loadMap(LS.comments); map[id] = arr; saveMap(LS.comments, map); };

        const renderComments = () => {
          const arr = readComments();
          listEl.innerHTML = '';
          if (!arr.length) return;
          const frag = document.createDocumentFragment();
          for (const c of arr) {
            const item = document.createElement('div');
            item.className = 'comment';
            item.innerHTML = `
              <div class="meta">
                <span>${escapeHTML(c.name)} · ${new Date(c.at).toLocaleString('ko-KR')}</span>
                <button class="del" data-id="${c.id}">삭제</button>
              </div>
              <div class="body">${escapeHTML(c.body)}</div>
            `;
            frag.appendChild(item);
          }
          listEl.appendChild(frag);
        };
        renderComments();

        listEl.addEventListener('click', (e) => {
          const btn = e.target.closest('.del'); if (!btn) return;
          const cid = btn.dataset.id;
          const arr = readComments().filter(c => c.id !== cid);
          writeComments(arr); renderComments();
        });

        form.addEventListener('submit', (e) => {
          e.preventDefault();
          const name = nameInput.value.trim();
          const body = bodyInput.value.trim();
          if (name.length < 2 || body.length < 1) return;
          const arr = readComments();
          const idGen = (crypto.randomUUID && crypto.randomUUID()) || String(Date.now()) + Math.random().toString(16).slice(2);
          const c = { id: idGen, name: name.slice(0, 20), body: body.slice(0, 500), at: Date.now() };
          arr.unshift(c);
          writeComments(arr); renderComments(); form.reset();
        });

        // 공유
        qs('#shareBtn').addEventListener('click', async (e) => {
          e.preventDefault();
          try {
            if (navigator.share) {
              await navigator.share({ title: data.title, text: '웹툰 보러 가기', url: location.href });
            } else {
              await navigator.clipboard.writeText(location.href);
              alert('링크가 복사되었습니다!');
            }
          } catch { }
        });

        // 스크롤 복원
        if ('scrollRestoration' in history) history.scrollRestoration = 'auto';
      } catch (err) {
        console.error(err);
        alert('에피소드를 불러오는 중 문제가 발생했습니다. manifest/data 경로와 JSON 형식을 확인해주세요.');
      }
    })();
  </script>
</body>

</html>