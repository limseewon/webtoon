<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì—í”¼ì†Œë“œ â€” ì‘ê°€ëª…</title>
  <meta name="description" content="ì‘ê°€ëª… ì›¹íˆ° ë·°ì–´" />
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <style>
    /* í˜ì´ì§€ ì „ìš© ë³´ì • (ì „ì—­ styles.cssì™€ í•¨ê»˜ ì‚¬ìš©) */
    :root {
      --brand: #66e0a3;
      --muted: #a8acb3;
    }

    .container-narrow {
      max-width: 820px;
      margin: 0 auto;
      padding: 20px
    }

    .viewer img {
      width: 100%;
      display: block;
      margin: 0 auto 12px
    }

    .viewer .skeleton {
      height: 600px;
      background: #111;
      border: 1px solid #222;
      border-radius: 12px;
      margin-bottom: 12px
    }

    .nav-episodes {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin: 16px 0
    }

    .btn {
      display: inline-block;
      background: var(--brand);
      color: #062d1d;
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 700
    }

    .btn.disabled,
    .btn[aria-disabled="true"] {
      opacity: .5;
      pointer-events: none
    }

    .muted {
      color: var(--muted)
    }

    .paywall {
      background: #111;
      border: 1px dashed #333;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      margin-top: 16px
    }

    .hidden {
      display: none
    }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="container">
      <a class="logo" href="/">ì‘ê°€ëª…</a>
      <nav>
        <a href="/archive.html">ì•„ì¹´ì´ë¸Œ</a>
        <a href="/support.html">í›„ì›</a>
      </nav>
    </div>
  </header>

  <main class="container-narrow">
    <article id="episode">
      <h1 id="ep-title">ë¡œë”© ì¤‘â€¦</h1>
      <p class="meta"><span id="ep-date">â€”</span> Â· <span id="ep-status">â€”</span></p>

      <div class="nav-episodes">
        <a id="prev-link" class="btn" href="#" aria-disabled="true">â† ì´ì „ í™”</a>
        <a id="next-link" class="btn" href="#" aria-disabled="true">ë‹¤ìŒ í™” â†’</a>
      </div>

      <div id="images" class="viewer" aria-live="polite"></div>

      <div id="paywall" class="paywall hidden">
        <h3>í›„ì›ì ì „ìš© ì—í”¼ì†Œë“œ</h3>
        <p class="muted">í›„ì›í•´ ì£¼ì‹œë©´ ë°”ë¡œ ì—´ëŒí•  ìˆ˜ ìˆì–´ìš”.</p>
        <a class="btn" href="/support.html">í›„ì›í•˜ëŸ¬ ê°€ê¸°</a>
      </div>

      <p class="muted" style="margin-top:24px">ëê¹Œì§€ ì½ì–´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ™Œ</p>
    </article>
  </main>

  <footer class="site-footer">
    <div class="container"><small>Â© <span id="year"></span> ì‘ê°€ëª…</small></div>
  </footer>

  <script>
    // ---- ìœ í‹¸ ----
    const qs = (s, el = document) => el.querySelector(s);
    const getParam = n => new URL(location.href).searchParams.get(n);
    const json = async url => { const r = await fetch(url, { cache: 'no-store' }); if (!r.ok) throw new Error('Fetch failed: ' + url); return r.json(); };

    // ---- ì´ˆê¸°í™” ----
    (async function init() {
      try {
        // í‘¸í„° ì—°ë„
        qs('#year').textContent = new Date().getFullYear();

        // 1) manifest ë¡œë“œ
        const manifest = await json('/episodes/manifest.json');
        const ids = manifest.episodes.map(e => e.id).sort(); // ep-0001, ep-0002 ...

        // 2) URL íŒŒë¼ë¯¸í„°(id) ì—†ìœ¼ë©´ ìµœì‹ í™”ë¡œ ì´ë™ (date ê¸°ì¤€)
        let id = getParam('id');
        if (!id) {
          const latest = [...manifest.episodes].sort((a, b) => new Date(b.date) - new Date(a.date))[0];
          location.replace(`/episode.html?id=${latest.id}`);
          return;
        }

        // id ìœ íš¨ì„± í™•ì¸
        if (!ids.includes(id)) {
          console.warn('Unknown episode id:', id);
          location.replace('/archive.html');
          return;
        }

        // 3) ì—í”¼ì†Œë“œ ë°ì´í„° ë¡œë“œ
        const data = await json(`/episodes/${id}/data.json`);

        // 4) ë©”íƒ€ ë Œë”
        qs('#ep-title').textContent = data.title;
        qs('#ep-date').textContent = new Date(data.date).toLocaleDateString('ko-KR');
        qs('#ep-status').textContent = data.locked ? 'í›„ì›ì ì „ìš©' : 'ë¬´ë£Œ';

        // 5) ì•/ë’¤ íšŒì°¨ ë§í¬ (idsëŠ” ì˜¤ë¦„ì°¨ìˆœ: ep-0001 < ep-0002)
        const index = ids.indexOf(id);
        const prevId = ids[index - 1] || null;
        const nextId = ids[index + 1] || null;
        const prev = qs('#prev-link');
        const next = qs('#next-link');
        if (prevId) { prev.href = `/episode.html?id=${prevId}`; prev.removeAttribute('aria-disabled'); } else { prev.classList.add('disabled'); }
        if (nextId) { next.href = `/episode.html?id=${nextId}`; next.removeAttribute('aria-disabled'); } else { next.classList.add('disabled'); }

        // 6) í˜ì´ì›” ì²˜ë¦¬
        if (data.locked) {
          qs('#paywall').classList.remove('hidden');
          return; // ì´ë¯¸ì§€ ë Œë” ìƒëµ
        }

        // 7) Lazy ì´ë¯¸ì§€ ë Œë”
        const wrap = qs('#images');
        const frag = document.createDocumentFragment();
        data.images.forEach(src => {
          const img = new Image();
          img.src = src;
          img.alt = data.title;
          img.loading = 'lazy';
          img.decoding = 'async';
          frag.appendChild(img);
        });
        wrap.appendChild(frag);

        // 8) ìŠ¤í¬ë¡¤ ë³µì›(ì„ íƒ)
        if ('scrollRestoration' in history) history.scrollRestoration = 'auto';
      } catch (err) {
        console.error(err);
        alert('ì—í”¼ì†Œë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. íŒŒì¼ ê²½ë¡œì™€ JSON í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      }
    })();
  </script>
</body>

</html>